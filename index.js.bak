const express = require('express');
const fs = require('fs');
const path = require('path');
const axios = require('axios');
const app = express();
const port = 3000;

const API_KEYS_FILE = path.join(__dirname, 'apiKeys.json');

// Middleware para verificar a chave da API
app.use((req, res, next) => {
  const key = req.query.key;
  if (!key) return res.status(401).json({ message: 'Chave da API é obrigatória' });

  const apiKeys = JSON.parse(fs.readFileSync(API_KEYS_FILE, 'utf8'));
  if(apiKeys[key]){
    if(apiKeys[key].used < apiKeys[key].limit){
      req.apiKey = key;
      next();
    } else {
      res.status(403).json({ message: 'Limite de uso excedido para esta chave.' });
    }
  } else {
    res.status(401).json({ message: 'Chave da API inválida.' });
  }
});

// Função utilitária para atualizar uso da key
function incrementKeyUsage(key){
  const keys = JSON.parse(fs.readFileSync(API_KEYS_FILE, 'utf8'));
  if(keys[key]){
    keys[key].used += 1;
    fs.writeFileSync(API_KEYS_FILE, JSON.stringify(keys, null, 2));
  }
}

// Endpoint de frases
app.get('/frases', (req, res) => {
  const data = fs.readFileSync(path.join(__dirname, 'frases.json'), 'utf8');
  const frases = JSON.parse(data).frases;
  const randomIndex = Math.floor(Math.random() * frases.length);
  incrementKeyUsage(req.apiKey);
  res.json({
    status: 'success',
    data: { frase: frases[randomIndex] },
    message: 'Frase retornada com sucesso'
  });
});

// Endpoint para consultar uso da key
app.get('/uso', (req, res) => {
  const keys = JSON.parse(fs.readFileSync(API_KEYS_FILE, 'utf8'));
  const keyData = keys[req.apiKey];
  res.json({
    status: 'success',
    data: {
      used: keyData.used,
      limit: keyData.limit,
      remaining: keyData.limit - keyData.used
    }
  });
});

// Exemplo de rota externa (CEP)
app.get('/consulta/:cep', async (req, res) => {
  try {
    const { cep } = req.params;
    const response = await axios.get(`https://viacep.com.br/ws/${cep}/json/`);
    incrementKeyUsage(req.apiKey);
    res.json({ status: 'success', data: response.data });
  } catch (err) {
    res.status(500).json({ status: 'error', message: 'Erro ao consultar CEP' });
  }
});

app.listen(port, () => console.log(`API rodando em http://localhost:${port}`));